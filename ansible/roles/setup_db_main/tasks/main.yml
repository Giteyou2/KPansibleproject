- name: Set hardcoded variables for Main DB setup
  ansible.builtin.set_fact:
    pg_version: "16"                                  # PostgreSQL 16 ë²„ì „ ì„¤ì •
    db_user: "admin"
    db_password: "admin"
    repl_user: "replicator"
    repl_password: "replicator"
    standby_ip: "172.16.6.57"                         # [í•„ìˆ˜ ìˆ˜ì •] ìŠ¤íƒ ë°”ì´ DB ì„œë²„ì˜ ì‹¤ì œ IP ì£¼ì†Œ
    pg_config_dir: "/var/lib/pgsql/16/data"           # PostgreSQL 16ì˜ ë°ì´í„° ë””ë ‰í† ë¦¬ ê²½ë¡œ (CentOS 9 ê¸°ì¤€)
    pg_service_name: "postgresql-16"                  # PostgreSQL 16 ì„œë¹„ìŠ¤ ì´ë¦„ (CentOS 9 ê¸°ì¤€)

# --- ê¸°ì¡´ PGDG ì €ì¥ì†Œ ì •ë¦¬ ë° ìºì‹œ ì´ˆê¸°í™” (GPG ì˜¤ë¥˜ ë°©ì§€) ---

- name: Remove any existing PGDG repository files
  ansible.builtin.find:
    paths: /etc/yum.repos.d
    patterns: 'pgdg-*.repo'
  register: existing_repos

- name: Delete found PGDG repository files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ existing_repos.files }}"

- name: Clean DNF metadata cache
  ansible.builtin.command: dnf clean all

# --- 1. PostgreSQL 16 ì„¤ì¹˜ ë° ì„œë¹„ìŠ¤ í™œì„±í™” (DNF ì‚¬ìš©) ---

# PostgreSQL ê³µì‹ GPG í‚¤ ê°€ì ¸ì˜¤ê¸° (ì €ì¥ì†Œ ë¬´ê²°ì„± ê²€ì¦)
- name: Import PostgreSQL GPG Key
  ansible.builtin.rpm_key:
    state: present
    key: "https://download.postgresql.org/pub/repos/yum/RPM-GPG-KEY-PGDG"

# ğŸ“Œ PostgreSQL 16 ë²„ì „ ì €ì¥ì†Œ ì¶”ê°€ (ì œê³µëœ EL-9 URL ì‚¬ìš©)
- name: Add PostgreSQL 16 Official Repository (EL-9 specific)
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present

# PostgreSQL 16 ì„œë²„ íŒ¨í‚¤ì§€ ì„¤ì¹˜
- name: Install PostgreSQL 16 server packages (RHEL/CentOS)
  ansible.builtin.dnf:
    name:
      - "postgresql16-server"       # PostgreSQL 16 ì„œë²„ íŒ¨í‚¤ì§€
      - "postgresql16-contrib"      # ì¶”ê°€ ìœ í‹¸ë¦¬í‹° íŒ¨í‚¤ì§€
    state: present

# PostgreSQL DB ì´ˆê¸°í™” (ë°ì´í„° ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ ìˆì„ ê²½ìš°ì—ë§Œ ì‹¤í–‰)
- name: Initialize PostgreSQL 16 database (Only if data directory is empty)
  ansible.builtin.command: "/usr/pgsql-16/bin/postgresql-16-setup initdb"
  args:
    creates: "{{ pg_config_dir }}/postgresql.conf"

# PostgreSQL ì„œë¹„ìŠ¤ ì‹œì‘ ë° ìë™ ì‹œì‘ ì„¤ì •
- name: Start PostgreSQL 16 service
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: started
    enabled: true

# DB ì ‘ì†ì„ ìœ„í•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Ansible ëª¨ë“ˆ ì‚¬ìš©ì„ ìœ„í•´ í•„ìˆ˜)
- name: Install Python required packages (psycopg2)
  ansible.builtin.dnf:
    name:
      - python3-psycopg2
    state: present

# --- 2. ë³µì œ ì‚¬ìš©ì ë° Zulip DB/ì‚¬ìš©ì ìƒì„± ---

# ìŠ¤íŠ¸ë¦¬ë° ë³µì œë¥¼ ìœ„í•œ 'replicator' ì‚¬ìš©ì ìƒì„±
- name: Create replication user
  community.postgresql.postgresql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    role_attr_flags: REPLICATION  # ë³µì œ ê¶Œí•œ ë¶€ì—¬
    state: present
    login_user: postgres
    host: /var/run/postgresql # ë¡œì»¬ ì†Œì¼“ì„ í†µí•œ ì ‘ì†
  become_user: postgres

# Zulip ì• í”Œë¦¬ì¼€ì´ì…˜ìš© ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
- name: Create Zulip database
  community.postgresql.postgresql_db:
    name: "zulip_production"
    state: present
    login_user: postgres
    host: /var/run/postgresql
  become_user: postgres

# Zulip ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ì('admin') ìƒì„± ë° DB ê¶Œí•œ ë¶€ì—¬
- name: Create Zulip application user
  community.postgresql.postgresql_user:
    db: "zulip_production"
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: ALL # Zulip DBì— ëŒ€í•œ ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
    state: present
    login_user: postgres
    host: /var/run/postgresql
  become_user: postgres

# --- 3. PostgreSQL ì„¤ì • íŒŒì¼ ìˆ˜ì • (postgresql.conf) ---

# ëª¨ë“  ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì ‘ì†ì„ í—ˆìš©í•˜ë„ë¡ ì„¤ì •
- name: Configure postgresql.conf listen_addresses
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/postgresql.conf"
    regexp: '^(.*)listen_addresses = .*$'
    line: "listen_addresses = '*'"
    backrefs: yes
    state: present

# ë³µì œì— í•„ìš”í•œ íŒŒë¼ë¯¸í„° ì„¤ì •
- name: Set required replication parameters on Main
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/postgresql.conf"
    line: "{{ item }}"
    state: present
    regexp: "^(.*){{ item.split('=')[0].strip() }}.*$"
    insertafter: EOF
  loop:
    - "wal_level = replica"       # ë³µì œë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ WAL ë ˆë²¨ ì„¤ì •
    - "max_wal_senders = 10"      # ìµœëŒ€ WAL ì†¡ì‹  í”„ë¡œì„¸ìŠ¤ ìˆ˜ ì„¤ì •
    - "hot_standby = on"          # Standby ì„œë²„ì—ì„œ ì½ê¸° ì¿¼ë¦¬ í—ˆìš©

# --- 4. ì ‘ì† í—ˆìš© ê·œì¹™ ìˆ˜ì • (pg_hba.conf) ---

# Standby ì„œë²„ì˜ ë³µì œ ì‚¬ìš©ì ì ‘ì† í—ˆìš© (IP ì£¼ì†Œ ê¸°ë°˜)
- name: Allow Standby connections in pg_hba.conf
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/pg_hba.conf"
    line: "host replication {{ repl_user }} {{ standby_ip }}/32 trust" # 'trust'ëŠ” ë³µì œ ì—°ê²°ì„ ìœ„í•´ ìì£¼ ì‚¬ìš©ë¨
    insertafter: EOF

# Zulip ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ìì˜ ì›ê²© ì ‘ì† í—ˆìš©
- name: Allow Zulip connections in pg_hba.conf
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/pg_hba.conf"
    line: "host zulip_production {{ db_user }} 0.0.0.0/0 md5" # ëª¨ë“  IPì—ì„œ md5 ì•”í˜¸í™” ì ‘ì† í—ˆìš©
    insertafter: EOF

# --- 5. PostgreSQL ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ---

# ë³€ê²½ëœ ì„¤ì • ì ìš©ì„ ìœ„í•´ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
- name: Restart PostgreSQL service on Main
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: restarted
    