- name: Set hardcoded variables for Main DB setup
  ansible.builtin.set_fact:
    pg_version: "16"                                  # PostgreSQL 16 버전 설정
    db_user: "admin"
    db_password: "admin"
    repl_user: "replicator"
    repl_password: "replicator"
    standby_ip: "172.16.6.57"                         # [필수 수정] 스탠바이 DB 서버의 실제 IP 주소
    pg_config_dir: "/var/lib/pgsql/16/data"           # PostgreSQL 16의 데이터 디렉토리 경로
    pg_service_name: "postgresql-16"                  # PostgreSQL 16 서비스 이름

# --- 1. PostgreSQL 16 설치 및 서비스 활성화 (DNF 사용) ---
# PostgreSQL 16 버전 저장소 추가 (제공된 EL-9 URL 사용)
- name: Add PostgreSQL 16 Official Repository (EL-9 specific)
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present

# PostgreSQL 16 서버 패키지 설치
- name: Install PostgreSQL 16 server packages (RHEL/CentOS)
  ansible.builtin.dnf:
    name:
      - "postgresql16-server"
      - "postgresql16-contrib"
    state: present

# PostgreSQL DB 초기화
- name: Initialize PostgreSQL 16 database (Only if data directory is empty)
  ansible.builtin.command: "/usr/pgsql-16/bin/postgresql-16-setup initdb"
  args:
    creates: "{{ pg_config_dir }}/postgresql.conf"

# PostgreSQL 서비스 시작 및 자동 시작 설정
- name: Start PostgreSQL 16 service
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: started
    enabled: true

# DB 접속을 위한 파이썬 패키지 설치
- name: Install Python required packages (psycopg2)
  ansible.builtin.dnf:
    name:
      - python3-psycopg2
    state: present

# --- 2. 복제 사용자 및 Zulip DB/사용자 생성 ---

# 스트리밍 복제를 위한 'replicator' 사용자 생성
- name: Create replication user
  community.postgresql.postgresql_user:
    name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    role_attr_flags: REPLICATION
    state: present
    login_user: postgres
    host: /var/run/postgresql
  become_user: postgres

# Zulip 애플리케이션용 데이터베이스 생성
- name: Create Zulip database
  community.postgresql.postgresql_db:
    name: "zulip_production"
    state: present
    login_user: postgres
    host: /var/run/postgresql
  become_user: postgres

# Zulip 애플리케이션 사용자('admin') 생성 및 DB 권한 부여
- name: Create Zulip application user
  community.postgresql.postgresql_user:
    db: "zulip_production"
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: ALL
    state: present
    login_user: postgres
    host: /var/run/postgresql
  become_user: postgres

# --- 3. PostgreSQL 설정 파일 수정 (postgresql.conf) ---

# 모든 네트워크 인터페이스에서 접속을 허용하도록 설정
- name: Configure postgresql.conf listen_addresses
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/postgresql.conf"
    regexp: '^(.*)listen_addresses = .*$'
    line: "listen_addresses = '*'"
    backrefs: yes
    state: present

# 복제에 필요한 파라미터 설정
- name: Set required replication parameters on Main
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/postgresql.conf"
    line: "{{ item }}"
    state: present
    regexp: "^(.*){{ item.split('=')[0].strip() }}.*$"
    insertafter: EOF
  loop:
    - "wal_level = replica"
    - "max_wal_senders = 10"
    - "hot_standby = on"

# --- 4. 접속 허용 규칙 수정 (pg_hba.conf) ---

# Standby 서버의 복제 사용자 접속 허용
- name: Allow Standby connections in pg_hba.conf
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/pg_hba.conf"
    line: "host replication {{ repl_user }} {{ standby_ip }}/32 trust"
    insertafter: EOF

# Zulip 애플리케이션 사용자의 원격 접속 허용
- name: Allow Zulip connections in pg_hba.conf
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/pg_hba.conf"
    line: "host zulip_production {{ db_user }} 0.0.0.0/0 md5"
    insertafter: EOF

# --- 5. PostgreSQL 서비스 재시작 ---

# 변경된 설정 적용을 위해 서비스 재시작
- name: Restart PostgreSQL service on Main
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: restarted
