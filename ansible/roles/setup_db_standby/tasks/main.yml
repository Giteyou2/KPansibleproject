- name: Set hardcoded variables for Standby DB setup
  ansible.builtin.set_fact:
    pg_version: "16"                                  # PostgreSQL 16 버전 설정
    main_db_ip: "172.16.6.56"                         # [필수 수정] 메인 DB 서버의 실제 IP 주소
    repl_user: "replicator"
    repl_password: "replicator"
    pg_config_dir: "/var/lib/pgsql/16/data"           # PostgreSQL 16의 데이터 디렉토리 경로
    pg_service_name: "postgresql-16"                  # PostgreSQL 16 서비스 이름

# --- 1. PostgreSQL 16 설치 및 서비스 비활성화 (DNF 사용) ---

# PostgreSQL 16 버전 GPG 키 가져오기 (404 오류 해결을 위해 경로 수정)
- name: Import PostgreSQL GPG Key
  ansible.builtin.rpm_key:
    state: present
    key: "https://download.postgresql.org/pub/repos/yum/RPM-GPG-KEY-PGDG-16"

# PostgreSQL 16 버전 저장소 추가 (제공된 EL-9 URL 사용)
- name: Add PostgreSQL 16 Official Repository (EL-9 specific)
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present

# PostgreSQL 16 서버 패키지 설치
- name: Install PostgreSQL 16 server packages (RHEL/CentOS)
  ansible.builtin.dnf:
    name:
      - "postgresql16-server"
      - "postgresql16-contrib"
    state: present

# 서비스가 실행되어 있다면 복제를 위해 잠시 중지
- name: Stop PostgreSQL service (if running)
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: stopped
    enabled: false # 자동 시작 방지

# DB 초기화를 위한 데이터 디렉토리 정리 및 재생성
- name: Ensure PostgreSQL data directory exists and is empty
  ansible.builtin.file:
    path: "{{ pg_config_dir }}"
    state: absent
  ignore_errors: true

- name: Re-create PostgreSQL data directory
  ansible.builtin.file:
    path: "{{ pg_config_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

# --- 2. Main DB에서 데이터 복사 (Base Backup) ---

# 메인 DB에서 데이터 디렉토리 전체를 복사
- name: Perform base backup from Main DB
  ansible.builtin.command: >
    /usr/pgsql-16/bin/pg_basebackup -h {{ main_db_ip }} -U {{ repl_user }} -D {{ pg_config_dir }} -P -R -w
  become: yes
  become_user: postgres

# --- 3. 설정 파일 수정 (PostgreSQL 12 버전 이후) ---

# standby.signal 파일 생성 (pg_basebackup의 -R 옵션이 실패했을 경우 대비)
- name: Create standby.signal file
  ansible.builtin.file:
    path: "{{ pg_config_dir }}/standby.signal"
    state: touch
    owner: postgres
    group: postgres
    mode: '0600'
  become: yes
  become_user: postgres

# 복제 연결 정보 설정
- name: Configure replication connection in postgresql.conf
  ansible.builtin.lineinfile:
    path: "{{ pg_config_dir }}/postgresql.conf"
    regexp: '^(.*)primary_conninfo = .*$'
    line: "primary_conninfo = 'host={{ main_db_ip }} user={{ repl_user }} password={{ repl_password }}'"
    insertafter: EOF
    state: present
  become: yes
  become_user: postgres

# --- 4. PostgreSQL 서비스 시작 ---

# 복제를 시작하기 위해 서비스 재시작 (standby 모드로 기동)
- name: Start PostgreSQL service on Standby
  ansible.builtin.service:
    name: "{{ pg_service_name }}"
    state: started
    enabled: true