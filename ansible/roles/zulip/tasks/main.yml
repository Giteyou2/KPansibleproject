---
# í•˜ë“œì½”ë”©ëœ ë³€ìˆ˜ ì„¤ì • (PostgreSQL, NFS ì„œë²„ ì ‘ì† ì •ë³´ ë° ê²½ë¡œ)
- name: Set necessary variables for external services
  ansible.builtin.set_fact:
    # NFS ì„¤ì • ë³€ìˆ˜ (ì™¸ë¶€ DB ì„¤ì •ì€ ì œê±°ë¨)
    nfs_server_ip: "{{ groups['nfs_server'][0] }}"
    nfs_export_path: "/mnt/zulip_data"
    zulip_storage_dir: "/opt/zulip/data"
    # DB ì ‘ì† ì •ë³´ ë³€ìˆ˜ (ë‚´ë¶€ DB ì‚¬ìš© ì‹œ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì œê±°í•´ë„ ë˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì£¼ì„ ì²˜ë¦¬)
    # db_user: "admin"
    # db_password: "admin"
# dbì„œë²„ ì œê±°ë¨
# --- 1. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ---

- name: Install prerequisites
  ansible.builtin.dnf:
    name:
      - git
      - curl
      - wget
      - tar
      - unzip
      - epel-release
      - nfs-utils
    state: present
  become: true

- name: Create zulip file if does not exist
  ansible.builtin.file:
    path: "{{ repo_dir }}"
    state: directory
    mode: '0755'
  become: true

# --- 2. Docker ë° Docker Compose ì„¤ì¹˜ ---

# ë„ì»¤ ì„¤ì¹˜
- name: Install Docker
  ansible.builtin.shell: |
    if ! command -v docker >/dev/null 2>&1; then
      curl -fsSL https://get.docker.com -o /root/get-docker.sh
      sh /root/get-docker.sh
    fi
    systemctl enable --now docker
  args:
    executable: /bin/bash
  become: true

# ë„ì»¤ ì»´í¬ì¦ˆ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
- name: Install docker compose plugin
  ansible.builtin.dnf:
    name: docker-compose-plugin
    state: present
  become: true
  ignore_errors: true

# --- 3. NFS ë§ˆìš´íŠ¸ ì„¤ì • (í˜¸ìŠ¤íŠ¸ ì„œë²„) ---
# (NFSëŠ” Zulip ë°ì´í„° ë³¼ë¥¨ìœ¼ë¡œ ê³„ì† ì‚¬ìš©ë˜ë¯€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤)

- name: Create local mount point for Zulip data on host
  ansible.builtin.file:
    path: "{{ zulip_storage_dir }}"
    state: directory
    mode: '0755'
  become: true

- name: Mount NFS share for Zulip data
  ansible.posix.mount:
    src: "{{ nfs_server_ip }}:{{ nfs_export_path }}"
    path: "{{ zulip_storage_dir }}"
    fstype: nfs
    opts: rw,sync,hard,intr
    state: mounted
  become: true

# --- 4. Zulip ì†ŒìŠ¤ ë° ì„¤ì • íŒŒì¼ ì¤€ë¹„ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„) ---

# zulip ê°€ì ¸ì˜¤ê¸°
- name: Clone docker-zulip
  ansible.builtin.git:
    repo: https://github.com/zulip/docker-zulip.git
    dest: "{{ repo_dir }}"
    force: yes
  become: true

# .env íŒŒì¼ ìƒì„± (ë‚´ë¶€ DB ì„¤ì •ìœ¼ë¡œ ë³€ê²½)
- name: Write .env (Modified for internal DB)
  ansible.builtin.copy:
    dest: "{{ repo_dir }}/.env"
    mode: '0666'
    content: |
      SETTINGS_FLAVOR=production
      ZULIP_ADMINISTRATOR="admin@{{ inventory_hostname }}"
      ZULIP_AUTH_BACKENDS=EmailAuthBackend
      ZULIP_DOMAIN={{ inventory_hostname }}
      ZULIP_REALM_NAME="Zulip Chat"
      SECRETS_email_password="change-me"
      SETTINGS_EXTERNAL_HOST={{ inventory_hostname }}
      
      # ğŸ“Œ ì™¸ë¶€ DB ì„¤ì • ì œê±°: EXTERNAL_POSTGRES ê´€ë ¨ ë³€ìˆ˜ ì‚­ì œ
      # Zulip ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ê°€ Docker Compose íŒŒì¼ ë‚´ì˜ ê¸°ë³¸ DB ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.
      
      # Zulipì´ ìë™ìœ¼ë¡œ ìƒì„±í•  DB ê³„ì •ì— ëŒ€í•œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œì¥)
      # Zulipì€ ì´ ë³€ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ë¶€ DBì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      # SECRETS_postgres_password="a-very-secret-password-for-internal-db" 
  become: true

# docker-compose.override.yml íŒŒì¼ ìƒì„± (NFS ë³¼ë¥¨ ë°”ì¸ë”© í¬í•¨)
# ì´ íŒŒì¼ì€ DB, Redis, RabbitMQ ì„œë¹„ìŠ¤ë¥¼ ìˆ¨ê¸°ì§€ ì•Šë„ë¡ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
- name: Write docker-compose.override.yml (Modified for external services)
  ansible.builtin.copy:
    dest: "{{ repo_dir }}/docker-compose.override.yml"
    mode: '0644'
    content: |
      version: '3.8'
      services:
        zulip:
          ports:
            - "80:80"
            - "443:443"
          environment:
            - ZULIP_DOMAIN={{ inventory_hostname }}
            - SETTINGS_EXTERNAL_HOST={{ inventory_hostname }}
            - SETTINGS_ALLOWED_HOSTS=["{{ inventory_hostname }}","localhost","127.0.0.1"]
            
          # í˜¸ìŠ¤íŠ¸ì˜ NFS ë§ˆìš´íŠ¸ ê²½ë¡œë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ë°ì´í„° ê²½ë¡œë¡œ ë°”ì¸ë”©
          volumes:
            - {{ zulip_storage_dir }}:/data:rw
  become: true

# --- 5. Zulip ìŠ¤íƒ ì‹œì‘ ---

- name: Start Zulip stack
  community.docker.docker_compose_v2:
    project_src: "{{ repo_dir }}"
    state: present
    pull: always
  become: true
