---
###############################
# 1) Ansible Control (Jenkins, ngrok)
###############################
- name: Setup Ansible control node with Jenkins + ngrok
  hosts: ansible_control
  become: true
  vars:
    jenkins_http_port: 8080
  roles:
    - ansible_control

#########################################
# 2) Monitoring (172.16.6.53) & Node Exporter
#########################################
- name: Setup Monitoring node
  hosts: monitoring
  become: true
  vars:
    mon_dir: /opt/monitoring
    prometheus_config: /opt/monitoring/prometheus/prometheus.yml
  roles:
    - monitoring

- name: Install Node Exporter (All hosts)
  hosts: all
  become: true
  roles:
    - node_exporter

#########################################
# 3) Setup NFS Server & Client Mount (Zulip 앱 서버보다 먼저 실행)
#########################################
- name: 1. Configure NFS Server
  hosts: nfs_server
  become: true
  roles:
    - setup_nfs_server # NFS 공유 설정 완료

- name: 2. Configure Zulip Clients to Mount NFS
  hosts: zulip
  become: true
  roles:
    - mount_nfs_client # Zulip 서버에 NFS 마운트 완료

################################
# 4) Deploy Zulip Application (LB 설치 직전 실행)
################################
- name: Deploy Zulip Application
  hosts: zulip
  become: true
  vars:
    repo_dir: /opt/docker-zulip
  # WAF 관련 변수는 더 이상 Zulip Role에 필요하지 않으므로 제거했습니다.
  roles:
    - zulip # NFS 마운트가 완료된 후 Zulip 스택 시작

################################
# 5) Setup Load Balancer (마지막에 실행)
################################
- name: Deploy Load Balancer (LB) on 172.16.6.55
  hosts: lb_servers
  become: true
  roles:
    - lb_setup

